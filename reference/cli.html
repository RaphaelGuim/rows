<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>cli.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>cli.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Copyright 2014-2019 √Ålvaro Justen <a href="https://github.com/turicas/rows/">https://github.com/turicas/rows/</a></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>You should have received a copy of the GNU Lesser General Public License
   along with this program.  If not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>TODO: define exit codes
TODO: move default options to base command
TODO: may move all &lsquo;destination&rsquo; to &lsquo;&ndash;output&rsquo;
TODO: test this whole module
TODO: add option to pass &lsquo;create_table&rsquo; options in command-line (like force
      fields)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">requests.exceptions</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">import</span> <span class="nn">rows</span>
<span class="kn">from</span> <span class="nn">rows.fields</span> <span class="kn">import</span> <span class="n">make_header</span>
<span class="kn">from</span> <span class="nn">rows.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">COMPRESSED_EXTENSIONS</span><span class="p">,</span>
    <span class="n">ProgressBar</span><span class="p">,</span>
    <span class="n">csv_to_sqlite</span><span class="p">,</span>
    <span class="n">detect_source</span><span class="p">,</span>
    <span class="n">download_file</span><span class="p">,</span>
    <span class="n">export_to_uri</span><span class="p">,</span>
    <span class="n">generate_schema</span><span class="p">,</span>
    <span class="n">import_from_source</span><span class="p">,</span>
    <span class="n">import_from_uri</span><span class="p">,</span>
    <span class="n">load_schema</span><span class="p">,</span>
    <span class="n">open_compressed</span><span class="p">,</span>
    <span class="n">pgexport</span><span class="p">,</span>
    <span class="n">pgimport</span><span class="p">,</span>
    <span class="n">sqlite_to_csv</span><span class="p">,</span>
    <span class="n">uncompressed_size</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">DEFAULT_BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="n">DEFAULT_INPUT_ENCODING</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
<span class="n">DEFAULT_INPUT_LOCALE</span> <span class="o">=</span> <span class="s2">&quot;C&quot;</span>
<span class="n">DEFAULT_OUTPUT_ENCODING</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
<span class="n">DEFAULT_OUTPUT_LOCALE</span> <span class="o">=</span> <span class="s2">&quot;C&quot;</span>
<span class="n">DEFAULT_SAMPLE_SIZE</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="n">HOME_PATH</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span>
<span class="n">CACHE_PATH</span> <span class="o">=</span> <span class="n">HOME_PATH</span> <span class="o">/</span> <span class="s2">&quot;.cache&quot;</span> <span class="o">/</span> <span class="s2">&quot;rows&quot;</span> <span class="o">/</span> <span class="s2">&quot;http&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">parse_options</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
    <span class="n">options_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="n">equal_position</span> <span class="o">=</span> <span class="n">option</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">equal_position</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Equal sign not found for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">option</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">options_dict</span><span class="p">[</span><span class="n">option</span><span class="p">[:</span><span class="n">equal_position</span><span class="p">]]</span> <span class="o">=</span> <span class="n">option</span><span class="p">[</span><span class="n">equal_position</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">options_dict</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">_import_table</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>TODO: may use import_from_uri instead</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">uri</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">uri</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s2">&quot;uri&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">source</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">import_from_uri</span><span class="p">(</span>
            <span class="n">uri</span><span class="p">,</span>
            <span class="n">default_encoding</span><span class="o">=</span><span class="n">DEFAULT_INPUT_ENCODING</span><span class="p">,</span>
            <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify_ssl</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span>
            <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">SSLError</span><span class="p">:</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span>
            <span class="s2">&quot;ERROR: SSL verification failed! &quot;</span> <span class="s2">&quot;Use `--verify-ssl=no` if you want to ignore.&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">table</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">_get_field_names</span><span class="p">(</span><span class="n">field_names</span><span class="p">,</span> <span class="n">table_field_names</span><span class="p">,</span> <span class="n">permit_not</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">new_field_names</span> <span class="o">=</span> <span class="n">make_header</span><span class="p">(</span><span class="n">field_names</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">),</span> <span class="n">permit_not</span><span class="o">=</span><span class="n">permit_not</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">permit_not</span><span class="p">:</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_field_names</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">table_field_names</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">field_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">new_field_names</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">table_field_names</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">])</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;Table does not have fields: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">missing</span><span class="p">),</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_field_names</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">_get_import_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">fields_exclude</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fields_exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;ERROR: `--fields` cannot be used with `--fields-exclude`&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_header</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">),</span> <span class="n">permit_not</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">_get_export_fields</span><span class="p">(</span><span class="n">table_field_names</span><span class="p">,</span> <span class="n">fields_exclude</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">fields_exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fields_exclude</span> <span class="o">=</span> <span class="n">_get_field_names</span><span class="p">(</span><span class="n">fields_exclude</span><span class="p">,</span> <span class="n">table_field_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">field_name</span> <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">table_field_names</span> <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields_exclude</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">_get_schemas_for_inputs</span><span class="p">(</span><span class="n">schemas</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">schemas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">schemas</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">schemas</span> <span class="o">=</span> <span class="p">[</span><span class="n">schema</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">schemas</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">schemas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
            <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;ERROR: number of schemas is greater than sources&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">schemas</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">schemas</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">diff</span><span class="p">):</span>
                <span class="n">schemas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">load_schema</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span> <span class="k">if</span> <span class="n">schema</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">schemas</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">AliasedGroup</span><span class="p">(</span><span class="n">click</span><span class="o">.</span><span class="n">Group</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">cmd_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">click</span><span class="o">.</span><span class="n">Group</span><span class="o">.</span><span class="n">get_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">cmd_name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">click</span><span class="o">.</span><span class="n">Group</span><span class="o">.</span><span class="n">get_command</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">cmd_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;-to-&quot;</span><span class="p">)</span>
        <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@click</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="n">AliasedGroup</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--http-cache&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--http-cache-path&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">CACHE_PATH</span><span class="o">.</span><span class="n">absolute</span><span class="p">()))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">version_option</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">rows</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span> <span class="n">prog_name</span><span class="o">=</span><span class="s2">&quot;rows&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cli</span><span class="p">(</span><span class="n">http_cache</span><span class="p">,</span> <span class="n">http_cache_path</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">http_cache</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">requests_cache</span>

        <span class="n">http_cache_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">http_cache_path</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">http_cache_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">http_cache_path</span><span class="o">.</span><span class="n">parent</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">http_cache_path</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.sqlite&quot;</span><span class="p">):</span>
            <span class="n">http_cache_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">http_cache_path</span><span class="p">)[:</span><span class="o">-</span><span class="mi">7</span><span class="p">])</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

        <span class="n">requests_cache</span><span class="o">.</span><span class="n">install_cache</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">http_cache_path</span><span class="p">))</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Convert table on `source` URI to `destination`&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--input-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--output-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--input-locale&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--output-locale&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--verify-ssl&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--order-by&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--fields&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A comma-separated list of fields to import&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--fields-exclude&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A comma-separated list of fields to exclude&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--input-option&quot;</span><span class="p">,</span>
    <span class="s2">&quot;-i&quot;</span><span class="p">,</span>
    <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Custom (import) plugin key=value custom option (can be specified multiple times)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--output-option&quot;</span><span class="p">,</span>
    <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
    <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Custom (export) plugin key=value custom option (can be specified multiple times)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--quiet&quot;</span><span class="p">,</span> <span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;destination&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">convert</span><span class="p">(</span>
    <span class="n">input_encoding</span><span class="p">,</span>
    <span class="n">output_encoding</span><span class="p">,</span>
    <span class="n">input_locale</span><span class="p">,</span>
    <span class="n">output_locale</span><span class="p">,</span>
    <span class="n">verify_ssl</span><span class="p">,</span>
    <span class="n">order_by</span><span class="p">,</span>
    <span class="n">fields</span><span class="p">,</span>
    <span class="n">fields_exclude</span><span class="p">,</span>
    <span class="n">input_option</span><span class="p">,</span>
    <span class="n">output_option</span><span class="p">,</span>
    <span class="n">quiet</span><span class="p">,</span>
    <span class="n">source</span><span class="p">,</span>
    <span class="n">destination</span><span class="p">,</span>
<span class="p">):</span>

    <span class="n">input_options</span> <span class="o">=</span> <span class="n">parse_options</span><span class="p">(</span><span class="n">input_option</span><span class="p">)</span>
    <span class="n">output_options</span> <span class="o">=</span> <span class="n">parse_options</span><span class="p">(</span><span class="n">output_option</span><span class="p">)</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">quiet</span>

    <span class="n">input_encoding</span> <span class="o">=</span> <span class="n">input_encoding</span> <span class="ow">or</span> <span class="n">input_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;encoding&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">source_info</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">input_encoding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">source_info</span> <span class="o">=</span> <span class="n">detect_source</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify_ssl</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">)</span>
        <span class="n">input_encoding</span> <span class="o">=</span> <span class="n">source_info</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">or</span> <span class="n">DEFAULT_INPUT_ENCODING</span>

    <span class="n">import_fields</span> <span class="o">=</span> <span class="n">_get_import_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">fields_exclude</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">input_locale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rows</span><span class="o">.</span><span class="n">locale_context</span><span class="p">(</span><span class="n">input_locale</span><span class="p">):</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">_import_table</span><span class="p">(</span>
                <span class="n">source_info</span> <span class="ow">or</span> <span class="n">source</span><span class="p">,</span>
                <span class="n">encoding</span><span class="o">=</span><span class="n">input_encoding</span><span class="p">,</span>
                <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify_ssl</span><span class="p">,</span>
                <span class="n">import_fields</span><span class="o">=</span><span class="n">import_fields</span><span class="p">,</span>
                <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                <span class="o">**</span><span class="n">input_options</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">_import_table</span><span class="p">(</span>
            <span class="n">source_info</span> <span class="ow">or</span> <span class="n">source</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">input_encoding</span><span class="p">,</span>
            <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify_ssl</span><span class="p">,</span>
            <span class="n">import_fields</span><span class="o">=</span><span class="n">import_fields</span><span class="p">,</span>
            <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
            <span class="o">**</span><span class="n">input_options</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">order_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">order_by</span> <span class="o">=</span> <span class="n">_get_field_names</span><span class="p">(</span><span class="n">order_by</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">field_names</span><span class="p">,</span> <span class="n">permit_not</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>TODO: use complete list of <code>order_by</code> fields</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">table</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">order_by</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">))</span>

    <span class="n">export_fields</span> <span class="o">=</span> <span class="n">_get_export_fields</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">field_names</span><span class="p">,</span> <span class="n">fields_exclude</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>TODO: may use sys.stdout.encoding if output_file = &lsquo;-&lsquo;</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">output_encoding</span> <span class="o">=</span> <span class="n">output_encoding</span> <span class="ow">or</span> <span class="n">DEFAULT_OUTPUT_ENCODING</span>
    <span class="k">if</span> <span class="n">output_locale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rows</span><span class="o">.</span><span class="n">locale_context</span><span class="p">(</span><span class="n">output_locale</span><span class="p">):</span>
            <span class="n">export_to_uri</span><span class="p">(</span>
                <span class="n">table</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">output_encoding</span><span class="p">,</span> <span class="n">export_fields</span><span class="o">=</span><span class="n">export_fields</span><span class="p">,</span> <span class="o">**</span><span class="n">output_options</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">export_to_uri</span><span class="p">(</span>
            <span class="n">table</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">output_encoding</span><span class="p">,</span> <span class="n">export_fields</span><span class="o">=</span><span class="n">export_fields</span><span class="p">,</span> <span class="o">**</span><span class="n">output_options</span><span class="p">,</span>
        <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Join tables from `source` URIs using `key(s)` to group &quot;</span> <span class="s2">&quot;rows and save into `destination`&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--input-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--output-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--input-locale&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--output-locale&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--verify-ssl&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--order-by&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--fields&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A comma-separated list of fields to export&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--fields-exclude&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A comma-separated list of fields to exclude when exporting&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;destination&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">join</span><span class="p">(</span>
    <span class="n">input_encoding</span><span class="p">,</span>
    <span class="n">output_encoding</span><span class="p">,</span>
    <span class="n">input_locale</span><span class="p">,</span>
    <span class="n">output_locale</span><span class="p">,</span>
    <span class="n">verify_ssl</span><span class="p">,</span>
    <span class="n">order_by</span><span class="p">,</span>
    <span class="n">fields</span><span class="p">,</span>
    <span class="n">fields_exclude</span><span class="p">,</span>
    <span class="n">keys</span><span class="p">,</span>
    <span class="n">sources</span><span class="p">,</span>
    <span class="n">destination</span><span class="p">,</span>
<span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>TODO: detect input_encoding for all sources</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">input_encoding</span> <span class="o">=</span> <span class="n">input_encoding</span> <span class="ow">or</span> <span class="n">DEFAULT_INPUT_ENCODING</span>

    <span class="n">export_fields</span> <span class="o">=</span> <span class="n">_get_import_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">fields_exclude</span><span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">make_header</span><span class="p">(</span><span class="n">keys</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">),</span> <span class="n">permit_not</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">input_locale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rows</span><span class="o">.</span><span class="n">locale_context</span><span class="p">(</span><span class="n">input_locale</span><span class="p">):</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="n">_import_table</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">input_encoding</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify_ssl</span><span class="p">)</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="n">_import_table</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">input_encoding</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify_ssl</span><span class="p">)</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">tables</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">order_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">order_by</span> <span class="o">=</span> <span class="n">_get_field_names</span><span class="p">(</span><span class="n">order_by</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">field_names</span><span class="p">,</span> <span class="n">permit_not</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>TODO: use complete list of <code>order_by</code> fields</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">result</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">order_by</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">export_fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">export_fields</span> <span class="o">=</span> <span class="n">_get_export_fields</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">field_names</span><span class="p">,</span> <span class="n">fields_exclude</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>TODO: may use sys.stdout.encoding if output_file = &lsquo;-&lsquo;</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">output_encoding</span> <span class="o">=</span> <span class="n">output_encoding</span> <span class="ow">or</span> <span class="n">DEFAULT_OUTPUT_ENCODING</span>
    <span class="k">if</span> <span class="n">output_locale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rows</span><span class="o">.</span><span class="n">locale_context</span><span class="p">(</span><span class="n">output_locale</span><span class="p">):</span>
            <span class="n">export_to_uri</span><span class="p">(</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">output_encoding</span><span class="p">,</span> <span class="n">export_fields</span><span class="o">=</span><span class="n">export_fields</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">export_to_uri</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">output_encoding</span><span class="p">,</span> <span class="n">export_fields</span><span class="o">=</span><span class="n">export_fields</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Sum tables from `source` URIs and save into `destination`&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--input-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--output-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--input-locale&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--output-locale&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--verify-ssl&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--order-by&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--fields&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A comma-separated list of fields to import&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--fields-exclude&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A comma-separated list of fields to exclude&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;destination&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sum_</span><span class="p">(</span>
    <span class="n">input_encoding</span><span class="p">,</span>
    <span class="n">output_encoding</span><span class="p">,</span>
    <span class="n">input_locale</span><span class="p">,</span>
    <span class="n">output_locale</span><span class="p">,</span>
    <span class="n">verify_ssl</span><span class="p">,</span>
    <span class="n">order_by</span><span class="p">,</span>
    <span class="n">fields</span><span class="p">,</span>
    <span class="n">fields_exclude</span><span class="p">,</span>
    <span class="n">sources</span><span class="p">,</span>
    <span class="n">destination</span><span class="p">,</span>
<span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>TODO: detect input_encoding for all sources</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">input_encoding</span> <span class="o">=</span> <span class="n">input_encoding</span> <span class="ow">or</span> <span class="n">DEFAULT_INPUT_ENCODING</span>

    <span class="n">import_fields</span> <span class="o">=</span> <span class="n">_get_import_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">fields_exclude</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">input_locale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rows</span><span class="o">.</span><span class="n">locale_context</span><span class="p">(</span><span class="n">input_locale</span><span class="p">):</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">_import_table</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">input_encoding</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify_ssl</span><span class="p">,</span> <span class="n">import_fields</span><span class="o">=</span><span class="n">import_fields</span><span class="p">,)</span>
                <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span>
            <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_import_table</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">input_encoding</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify_ssl</span><span class="p">,</span> <span class="n">import_fields</span><span class="o">=</span><span class="n">import_fields</span><span class="p">,)</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span>
        <span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">order_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">order_by</span> <span class="o">=</span> <span class="n">_get_field_names</span><span class="p">(</span><span class="n">order_by</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">field_names</span><span class="p">,</span> <span class="n">permit_not</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>TODO: use complete list of <code>order_by</code> fields</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">result</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">order_by</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">))</span>

    <span class="n">export_fields</span> <span class="o">=</span> <span class="n">_get_export_fields</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">field_names</span><span class="p">,</span> <span class="n">fields_exclude</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>TODO: may use sys.stdout.encoding if output_file = &lsquo;-&lsquo;</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">output_encoding</span> <span class="o">=</span> <span class="n">output_encoding</span> <span class="ow">or</span> <span class="n">DEFAULT_OUTPUT_ENCODING</span>
    <span class="k">if</span> <span class="n">output_locale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rows</span><span class="o">.</span><span class="n">locale_context</span><span class="p">(</span><span class="n">output_locale</span><span class="p">):</span>
            <span class="n">export_to_uri</span><span class="p">(</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">output_encoding</span><span class="p">,</span> <span class="n">export_fields</span><span class="o">=</span><span class="n">export_fields</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">export_to_uri</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">output_encoding</span><span class="p">,</span> <span class="n">export_fields</span><span class="o">=</span><span class="n">export_fields</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;print&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print a table&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--input-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--output-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--input-locale&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--input-option&quot;</span><span class="p">,</span>
    <span class="s2">&quot;-i&quot;</span><span class="p">,</span>
    <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Custom (import) plugin key=value custom option (can be specified multiple times)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--output-locale&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--frame-style&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Options: ascii, single, double, none&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--table-index&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--verify-ssl&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--fields&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A comma-separated list of fields to import&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--fields-exclude&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A comma-separated list of fields to exclude&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--order-by&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--quiet&quot;</span><span class="p">,</span> <span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">print_</span><span class="p">(</span>
    <span class="n">input_encoding</span><span class="p">,</span>
    <span class="n">output_encoding</span><span class="p">,</span>
    <span class="n">input_locale</span><span class="p">,</span>
    <span class="n">input_option</span><span class="p">,</span>
    <span class="n">output_locale</span><span class="p">,</span>
    <span class="n">frame_style</span><span class="p">,</span>
    <span class="n">table_index</span><span class="p">,</span>
    <span class="n">verify_ssl</span><span class="p">,</span>
    <span class="n">fields</span><span class="p">,</span>
    <span class="n">fields_exclude</span><span class="p">,</span>
    <span class="n">order_by</span><span class="p">,</span>
    <span class="n">quiet</span><span class="p">,</span>
    <span class="n">source</span><span class="p">,</span>
<span class="p">):</span>

    <span class="n">input_options</span> <span class="o">=</span> <span class="n">parse_options</span><span class="p">(</span><span class="n">input_option</span><span class="p">)</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">quiet</span>
    <span class="n">input_encoding</span> <span class="o">=</span> <span class="n">input_encoding</span> <span class="ow">or</span> <span class="n">input_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;encoding&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">source_info</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">input_encoding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">source_info</span> <span class="o">=</span> <span class="n">detect_source</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify_ssl</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">)</span>
        <span class="n">input_encoding</span> <span class="o">=</span> <span class="n">source_info</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">or</span> <span class="n">DEFAULT_INPUT_ENCODING</span>

    <span class="n">import_fields</span> <span class="o">=</span> <span class="n">_get_import_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">fields_exclude</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>TODO: if create_table implements <code>fields_exclude</code> this _import_table call
will import only the desired data</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">input_locale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rows</span><span class="o">.</span><span class="n">locale_context</span><span class="p">(</span><span class="n">input_locale</span><span class="p">):</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">_import_table</span><span class="p">(</span>
                <span class="n">source_info</span> <span class="ow">or</span> <span class="n">source</span><span class="p">,</span>
                <span class="n">encoding</span><span class="o">=</span><span class="n">input_encoding</span><span class="p">,</span>
                <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify_ssl</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="n">table_index</span><span class="p">,</span>
                <span class="n">import_fields</span><span class="o">=</span><span class="n">import_fields</span><span class="p">,</span>
                <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                <span class="o">**</span><span class="n">input_options</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">_import_table</span><span class="p">(</span>
            <span class="n">source_info</span> <span class="ow">or</span> <span class="n">source</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">input_encoding</span><span class="p">,</span>
            <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify_ssl</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="n">table_index</span><span class="p">,</span>
            <span class="n">import_fields</span><span class="o">=</span><span class="n">import_fields</span><span class="p">,</span>
            <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
            <span class="o">**</span><span class="n">input_options</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">order_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">order_by</span> <span class="o">=</span> <span class="n">_get_field_names</span><span class="p">(</span><span class="n">order_by</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">field_names</span><span class="p">,</span> <span class="n">permit_not</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>TODO: use complete list of <code>order_by</code> fields</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">table</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">order_by</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">))</span>

    <span class="n">export_fields</span> <span class="o">=</span> <span class="n">_get_export_fields</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">field_names</span><span class="p">,</span> <span class="n">fields_exclude</span><span class="p">)</span>
    <span class="n">output_encoding</span> <span class="o">=</span> <span class="n">output_encoding</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">or</span> <span class="n">DEFAULT_OUTPUT_ENCODING</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>TODO: may use output_options instead of custom TXT plugin options</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">fobj</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">output_locale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rows</span><span class="o">.</span><span class="n">locale_context</span><span class="p">(</span><span class="n">output_locale</span><span class="p">):</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">export_to_txt</span><span class="p">(</span>
                <span class="n">table</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">output_encoding</span><span class="p">,</span> <span class="n">export_fields</span><span class="o">=</span><span class="n">export_fields</span><span class="p">,</span> <span class="n">frame_style</span><span class="o">=</span><span class="n">frame_style</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">export_to_txt</span><span class="p">(</span>
            <span class="n">table</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">output_encoding</span><span class="p">,</span> <span class="n">export_fields</span><span class="o">=</span><span class="n">export_fields</span><span class="p">,</span> <span class="n">frame_style</span><span class="o">=</span><span class="n">frame_style</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">fobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>TODO: may pass unicode to click.echo if output_encoding is not provided</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">fobj</span><span class="o">.</span><span class="n">read</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Query a table using SQL&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--input-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--output-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--input-locale&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--output-locale&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--verify-ssl&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--samples&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of rows to determine the field types (0 = all)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--input-option&quot;</span><span class="p">,</span>
    <span class="s2">&quot;-i&quot;</span><span class="p">,</span>
    <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Custom (import) plugin key=value custom option (can be specified multiple times)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--output&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--frame-style&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Options: ascii, single, double, none&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--quiet&quot;</span><span class="p">,</span> <span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
    <span class="n">input_encoding</span><span class="p">,</span>
    <span class="n">output_encoding</span><span class="p">,</span>
    <span class="n">input_locale</span><span class="p">,</span>
    <span class="n">output_locale</span><span class="p">,</span>
    <span class="n">verify_ssl</span><span class="p">,</span>
    <span class="n">samples</span><span class="p">,</span>
    <span class="n">input_option</span><span class="p">,</span>
    <span class="n">output</span><span class="p">,</span>
    <span class="n">frame_style</span><span class="p">,</span>
    <span class="n">quiet</span><span class="p">,</span>
    <span class="n">query</span><span class="p">,</span>
    <span class="n">sources</span><span class="p">,</span>
<span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>TODO: support multiple input options
TODO: detect input_encoding for all sources</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">input_encoding</span> <span class="o">=</span> <span class="n">input_encoding</span> <span class="ow">or</span> <span class="n">DEFAULT_INPUT_ENCODING</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">quiet</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span> <span class="k">if</span> <span class="n">samples</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;select&quot;</span><span class="p">):</span>
        <span class="n">table_names</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;table</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM </span><span class="si">{}</span><span class="s2"> WHERE </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_names</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">detect_source</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify_ssl</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">plugin_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;sqlite&quot;</span><span class="p">,</span> <span class="s2">&quot;postgresql&quot;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p>Optimization: query the db directly</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">result</span> <span class="o">=</span> <span class="n">import_from_source</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">input_encoding</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">input_locale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">rows</span><span class="o">.</span><span class="n">locale_context</span><span class="p">(</span><span class="n">input_locale</span><span class="p">):</span>
                    <span class="n">table</span> <span class="o">=</span> <span class="n">import_from_source</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">input_encoding</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="n">import_from_source</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">input_encoding</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">)</span>

            <span class="n">sqlite_connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">export_to_sqlite</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">sqlite_connection</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;table1&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">import_from_sqlite</span><span class="p">(</span><span class="n">sqlite_connection</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>TODO: if all sources are SQLite we can also optimize the import</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">input_locale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">rows</span><span class="o">.</span><span class="n">locale_context</span><span class="p">(</span><span class="n">input_locale</span><span class="p">):</span>
                <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">_import_table</span><span class="p">(</span>
                        <span class="n">source</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">input_encoding</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify_ssl</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span>
                <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">_import_table</span><span class="p">(</span>
                    <span class="n">source</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">input_encoding</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify_ssl</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span>
            <span class="p">]</span>

        <span class="n">sqlite_connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tables</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">export_to_sqlite</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">sqlite_connection</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;table</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">import_from_sqlite</span><span class="p">(</span><span class="n">sqlite_connection</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>TODO: may use sys.stdout.encoding if output_file = &lsquo;-&lsquo;</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">output_encoding</span> <span class="o">=</span> <span class="n">output_encoding</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">or</span> <span class="n">DEFAULT_OUTPUT_ENCODING</span>
    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fobj</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">output_locale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">rows</span><span class="o">.</span><span class="n">locale_context</span><span class="p">(</span><span class="n">output_locale</span><span class="p">):</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">export_to_txt</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">output_encoding</span><span class="p">,</span> <span class="n">frame_style</span><span class="o">=</span><span class="n">frame_style</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">export_to_txt</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">output_encoding</span><span class="p">,</span> <span class="n">frame_style</span><span class="o">=</span><span class="n">frame_style</span><span class="p">)</span>
        <span class="n">fobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">fobj</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">output_locale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">rows</span><span class="o">.</span><span class="n">locale_context</span><span class="p">(</span><span class="n">output_locale</span><span class="p">):</span>
                <span class="n">export_to_uri</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">output_encoding</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">export_to_uri</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">output_encoding</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;schema&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Identifies table schema&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--input-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--input-locale&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--verify-ssl&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--detect-all-types&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--input-option&quot;</span><span class="p">,</span>
    <span class="s2">&quot;-i&quot;</span><span class="p">,</span>
    <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Custom (import) plugin key=value custom option (can be specified multiple times)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;--format&quot;</span><span class="p">,</span> <span class="s2">&quot;output_format&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;txt&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">((</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="s2">&quot;django&quot;</span><span class="p">,</span> <span class="s2">&quot;sql&quot;</span><span class="p">,</span> <span class="s2">&quot;txt&quot;</span><span class="p">)),</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--fields&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A comma-separated list of fields to inspect&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--fields-exclude&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A comma-separated list of fields to exclude from inspection&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--samples&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of rows to determine the field types (0 = all)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--quiet&quot;</span><span class="p">,</span> <span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">schema</span><span class="p">(</span>
    <span class="n">input_encoding</span><span class="p">,</span>
    <span class="n">input_locale</span><span class="p">,</span>
    <span class="n">verify_ssl</span><span class="p">,</span>
    <span class="n">detect_all_types</span><span class="p">,</span>
    <span class="n">input_option</span><span class="p">,</span>
    <span class="n">output_format</span><span class="p">,</span>
    <span class="n">fields</span><span class="p">,</span>
    <span class="n">fields_exclude</span><span class="p">,</span>
    <span class="n">samples</span><span class="p">,</span>
    <span class="n">quiet</span><span class="p">,</span>
    <span class="n">source</span><span class="p">,</span>
    <span class="n">output</span><span class="p">,</span>
<span class="p">):</span>

    <span class="n">input_options</span> <span class="o">=</span> <span class="n">parse_options</span><span class="p">(</span><span class="n">input_option</span><span class="p">)</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">quiet</span>
    <span class="n">input_encoding</span> <span class="o">=</span> <span class="n">input_encoding</span> <span class="ow">or</span> <span class="n">input_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;encoding&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DEFAULT_INPUT_ENCODING</span>
    <span class="n">source_info</span> <span class="o">=</span> <span class="n">detect_source</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify_ssl</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">)</span>
    <span class="n">source_info</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">input_encoding</span>  <span class="c1"># TODO: fix `detect_source`</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span> <span class="k">if</span> <span class="n">samples</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">import_fields</span> <span class="o">=</span> <span class="n">_get_import_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">fields_exclude</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">detect_all_types</span><span class="p">:</span>
        <span class="n">field_types_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">field_name</span> <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">rows</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">__all__</span> <span class="k">if</span> <span class="n">field_name</span> <span class="o">!=</span> <span class="s2">&quot;Field&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">field_types_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">FieldClass</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">FieldClass</span> <span class="ow">in</span> <span class="n">rows</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">DEFAULT_TYPES</span> <span class="k">if</span> <span class="n">FieldClass</span> <span class="o">!=</span> <span class="n">rows</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Field</span>
        <span class="p">]</span>
    <span class="n">field_types</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">rows</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">field_types_names</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">input_locale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rows</span><span class="o">.</span><span class="n">locale_context</span><span class="p">(</span><span class="n">input_locale</span><span class="p">):</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">import_from_source</span><span class="p">(</span>
                <span class="n">source_info</span><span class="p">,</span>
                <span class="n">input_encoding</span><span class="p">,</span>
                <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
                <span class="n">import_fields</span><span class="o">=</span><span class="n">import_fields</span><span class="p">,</span>
                <span class="n">max_rows</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
                <span class="n">field_types</span><span class="o">=</span><span class="n">field_types</span><span class="p">,</span>
                <span class="o">**</span><span class="n">input_options</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">import_from_source</span><span class="p">(</span>
            <span class="n">source_info</span><span class="p">,</span>
            <span class="n">input_encoding</span><span class="p">,</span>
            <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
            <span class="n">import_fields</span><span class="o">=</span><span class="n">import_fields</span><span class="p">,</span>
            <span class="n">max_rows</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
            <span class="n">field_types</span><span class="o">=</span><span class="n">field_types</span><span class="p">,</span>
            <span class="o">**</span><span class="n">input_options</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">export_fields</span> <span class="o">=</span> <span class="n">_get_export_fields</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">field_names</span><span class="p">,</span> <span class="n">fields_exclude</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">export_fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">export_fields</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">field_names</span>
    <span class="k">if</span> <span class="n">output</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">output_fobj</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">buffer</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_fobj</span> <span class="o">=</span> <span class="n">open_compressed</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">generate_schema</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">export_fields</span><span class="p">,</span> <span class="n">output_format</span><span class="p">)</span>
    <span class="n">output_fobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;csv-to-sqlite&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Convert one or more CSV files to SQLite&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--batch-size&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--samples&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of rows to determine the field types (0 = all)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--input-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--dialect&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--schemas&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">command_csv_to_sqlite</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">input_encoding</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">schemas</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>TODO: add &ndash;quiet</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>TODO: detect input_encoding for all sources</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">input_encoding</span> <span class="o">=</span> <span class="n">input_encoding</span> <span class="ow">or</span> <span class="n">DEFAULT_INPUT_ENCODING</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>TODO: if table_name is &ldquo;2019&rdquo; the final name will be &ldquo;field_2019&rdquo; - must
      be &ldquo;table_2019&rdquo;</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">table_names</span> <span class="o">=</span> <span class="n">make_header</span><span class="p">([</span><span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">])</span>
    <span class="n">schemas</span> <span class="o">=</span> <span class="n">_get_schemas_for_inputs</span><span class="p">(</span><span class="n">schemas</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">table_names</span><span class="p">,</span> <span class="n">schemas</span><span class="p">):</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{filename}</span><span class="s2"> -&gt; </span><span class="si">{db_filename}</span><span class="s2">#</span><span class="si">{tablename}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">db_filename</span><span class="o">=</span><span class="n">output</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tablename</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>TODO: if <code>schemas</code> is present, will not detect data types</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">pre_prefix</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (detecting data types)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">pre_prefix</span><span class="o">=</span><span class="n">pre_prefix</span><span class="p">)</span>
        <span class="n">csv_to_sqlite</span><span class="p">(</span>
            <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
            <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">output</span><span class="p">),</span>
            <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">,</span>
            <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
            <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">input_encoding</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;sqlite-to-csv&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Convert a SQLite table into CSV&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--batch-size&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--dialect&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;excel&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">command_sqlite_to_csv</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>TODO: add &ndash;quiet
TODO: add output options/encoding</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">input_filename</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">output_filename</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{db_filename}</span><span class="s2">#</span><span class="si">{tablename}</span><span class="s2"> -&gt; </span><span class="si">{filename}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">db_filename</span><span class="o">=</span><span class="n">input_filename</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tablename</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">output_filename</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">pre_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">sqlite_to_csv</span><span class="p">(</span>
        <span class="n">input_filename</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">input_filename</span><span class="p">),</span>
        <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
        <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">,</span>
        <span class="n">output_filename</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">output_filename</span><span class="p">),</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">callback</span><span class="o">=</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;pgimport&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Import a CSV file into a PostgreSQL table&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--input-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--no-create-table&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--dialect&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--schema&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--unlogged&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;database_uri&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">command_pgimport</span><span class="p">(</span><span class="n">input_encoding</span><span class="p">,</span> <span class="n">no_create_table</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">unlogged</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">database_uri</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>TODO: add &ndash;quiet
TODO: may detect encoding here (instead of inside rows.utils.pgimport)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>First, detect file size</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">class</span> <span class="nc">CustomProgressBar</span><span class="p">(</span><span class="n">ProgressBar</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">n</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">total</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>The total size reached a level above the detected one,
probabaly error on gzip (it has only 32 bits to store
uncompressed size, so if uncompressed size is greater than
4GB, it will have truncated data). If this happens, we update
the total by adding a bit <code>1</code> to left of the original size
(in bits). It may not be the correct uncompressed size (more
than one bit could be truncated, so the process will repeat.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_total</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bit_updates</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">new_total</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bit_updates</span> <span class="o">&lt;&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nb">bin</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;0b&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span> <span class="o">^</span> <span class="n">n</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">new_total</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>TODO: update total when finish (total = n)?</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">CustomProgressBar</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;Importing data&quot;</span><span class="p">,</span> <span class="n">pre_prefix</span><span class="o">=</span><span class="s2">&quot;Detecting file size&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;bytes&quot;</span><span class="p">)</span>
    <span class="n">compressed_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="n">uncompressed_size</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="n">compressed_size</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">progress_bar</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">total_size</span> <span class="k">if</span> <span class="n">total_size</span> <span class="o">&gt;</span> <span class="n">compressed_size</span> <span class="k">else</span> <span class="n">compressed_size</span>
        <span class="n">progress_bar</span><span class="o">.</span><span class="n">original_total</span> <span class="o">=</span> <span class="n">total_size</span>
        <span class="n">progress_bar</span><span class="o">.</span><span class="n">bit_updates</span> <span class="o">=</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      <p>Then, define its schema</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">schema</span><span class="p">:</span>
        <span class="n">progress_bar</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Reading schema&quot;</span>
        <span class="n">schemas</span> <span class="o">=</span> <span class="n">_get_schemas_for_inputs</span><span class="p">(</span><span class="n">schema</span> <span class="k">if</span> <span class="n">schema</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">source</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">progress_bar</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Detecting schema&quot;</span>
        <span class="n">schemas</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      <p>So we can finally import it!</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">import_meta</span> <span class="o">=</span> <span class="n">pgimport</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
        <span class="n">encoding</span><span class="o">=</span><span class="n">input_encoding</span><span class="p">,</span>
        <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">,</span>
        <span class="n">database_uri</span><span class="o">=</span><span class="n">database_uri</span><span class="p">,</span>
        <span class="n">create_table</span><span class="o">=</span><span class="ow">not</span> <span class="n">no_create_table</span><span class="p">,</span>
        <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
        <span class="n">callback</span><span class="o">=</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">=</span><span class="n">schemas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">unlogged</span><span class="o">=</span><span class="n">unlogged</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">progress_bar</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> rows imported&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">import_meta</span><span class="p">[</span><span class="s2">&quot;rows_imported&quot;</span><span class="p">])</span>
    <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;pgexport&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Export a PostgreSQL table into a CSV file&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--is-query&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--output-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--dialect&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;excel&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;database_uri&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;destination&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">command_pgexport</span><span class="p">(</span><span class="n">is_query</span><span class="p">,</span> <span class="n">output_encoding</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">database_uri</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      <p>TODO: add &ndash;quiet</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">updater</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;Exporting data&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;bytes&quot;</span><span class="p">)</span>
    <span class="n">pgexport</span><span class="p">(</span>
        <span class="n">database_uri</span><span class="o">=</span><span class="n">database_uri</span><span class="p">,</span>
        <span class="n">table_name_or_query</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
        <span class="n">is_query</span><span class="o">=</span><span class="n">is_query</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">destination</span><span class="p">,</span>
        <span class="n">encoding</span><span class="o">=</span><span class="n">output_encoding</span><span class="p">,</span>
        <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">,</span>
        <span class="n">callback</span><span class="o">=</span><span class="n">updater</span><span class="o">.</span><span class="n">update</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">updater</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;pdf-to-text&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Extract text from a PDF&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--input-option&quot;</span><span class="p">,</span>
    <span class="s2">&quot;-i&quot;</span><span class="p">,</span>
    <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Custom (import) plugin key=value custom option (can be specified multiple times)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--output-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--quiet&quot;</span><span class="p">,</span> <span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--backend&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--pages&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">command_pdf_to_text</span><span class="p">(</span><span class="n">input_option</span><span class="p">,</span> <span class="n">output_encoding</span><span class="p">,</span> <span class="n">quiet</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>

    <span class="n">input_options</span> <span class="o">=</span> <span class="n">parse_options</span><span class="p">(</span><span class="n">input_option</span><span class="p">)</span>
    <span class="n">input_options</span><span class="p">[</span><span class="s2">&quot;backend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backend</span> <span class="ow">or</span> <span class="n">input_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backend&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      <p>Define page range</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">input_options</span><span class="p">[</span><span class="s2">&quot;page_numbers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages</span> <span class="ow">or</span> <span class="n">input_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;page_numbers&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">input_options</span><span class="p">[</span><span class="s2">&quot;page_numbers&quot;</span><span class="p">]:</span>
        <span class="n">input_options</span><span class="p">[</span><span class="s2">&quot;page_numbers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">extract_intervals</span><span class="p">(</span><span class="n">input_options</span><span class="p">[</span><span class="s2">&quot;page_numbers&quot;</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      <p>Define if output is file or stdout</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">open_compressed</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">output_encoding</span><span class="p">)</span>
        <span class="n">write</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">write</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">write</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">echo</span>
        <span class="n">quiet</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">quiet</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      <p>Download the file if source is an HTTP URL</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">downloaded</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http:&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">source</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;https:&quot;</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span> <span class="n">detect</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">uri</span>
        <span class="n">downloaded</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">reader</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">pdf_to_text</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">**</span><span class="n">input_options</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">progress</span><span class="p">:</span>  <span class="c1"># Calculate total number of pages and create a progress bar</span>
        <span class="k">if</span> <span class="n">input_options</span><span class="p">[</span><span class="s2">&quot;page_numbers&quot;</span><span class="p">]:</span>
            <span class="n">total_pages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_options</span><span class="p">[</span><span class="s2">&quot;page_numbers&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">total_pages</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">number_of_pages</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">input_options</span><span class="p">[</span><span class="s2">&quot;backend&quot;</span><span class="p">])</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Extracting text&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total_pages</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
        <span class="n">write</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">downloaded</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">source</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;csv-merge&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Lazily merge CSVs (even if the schemas differs)&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--input-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--output-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--no-strip&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--no-remove-empty-lines&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--sample-size&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_SAMPLE_SIZE</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--buffer-size&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_BUFFER_SIZE</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;destination&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">csv_merge</span><span class="p">(</span>
    <span class="n">input_encoding</span><span class="p">,</span> <span class="n">output_encoding</span><span class="p">,</span> <span class="n">no_strip</span><span class="p">,</span> <span class="n">no_remove_empty_lines</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">destination</span>
<span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      <p>TODO: add option to preserve original key names
TODO: detect input_encoding for all sources
TODO: add &ndash;quiet</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">strip</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">no_strip</span>
    <span class="n">remove_empty_lines</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">no_remove_empty_lines</span>
    <span class="n">input_encoding</span> <span class="o">=</span> <span class="n">input_encoding</span> <span class="ow">or</span> <span class="n">DEFAULT_INPUT_ENCODING</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">final_header</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Detecting dialects and headers&quot;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>
      <p>Detect dialect</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">with</span> <span class="n">open_compressed</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fobj</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">fobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">sample_size</span><span class="p">)</span>
        <span class="n">dialect</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">csv</span><span class="o">.</span><span class="n">discover_dialect</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">input_encoding</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s2">&quot;dialect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dialect</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      <p>Get header
TODO: fix final header in case of empty field names (a command like
<code>rows csv-clean</code> would fix the problem if run before <code>csv-merge</code> for
each file).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">metadata</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s2">&quot;fobj&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">open_compressed</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">input_encoding</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s2">&quot;reader&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s2">&quot;fobj&quot;</span><span class="p">],</span> <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s2">&quot;header&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s2">&quot;reader&quot;</span><span class="p">])</span>
        <span class="n">metadata</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s2">&quot;header_map&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s2">&quot;header&quot;</span><span class="p">]:</span>
            <span class="n">field_name_slug</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">slug</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="s2">&quot;header_map&quot;</span><span class="p">][</span><span class="n">field_name_slug</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_name</span>
            <span class="k">if</span> <span class="n">field_name_slug</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_header</span><span class="p">:</span>
                <span class="n">final_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_name_slug</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      <p>TODO: is it needed to use make_header here?</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Exporting data&quot;</span><span class="p">)</span>
    <span class="n">output_fobj</span> <span class="o">=</span> <span class="n">open_compressed</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">output_encoding</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">output_fobj</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">final_header</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sources</span><span class="p">):</span>
        <span class="n">progress_bar</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;Exporting data </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">))</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>
        <span class="n">field_indexes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;header&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span> <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;header&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">final_header</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">strip</span><span class="p">:</span>
            <span class="n">create_new_row</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">field_indexes</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">create_new_row</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">field_indexes</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;reader&quot;</span><span class="p">]:</span>
            <span class="n">new_row</span> <span class="o">=</span> <span class="n">create_new_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remove_empty_lines</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">new_row</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">new_row</span><span class="p">)</span>
            <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;fobj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">output_fobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>
      <p>Create a consistent and clean version of a CSV file</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;csv-clean&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--input-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--output-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--sample-size&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_SAMPLE_SIZE</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--buffer-size&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_BUFFER_SIZE</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--in-place&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;destination&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">csv_clean</span><span class="p">(</span><span class="n">input_encoding</span><span class="p">,</span> <span class="n">output_encoding</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">,</span> <span class="n">in_place</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      <p>The tasks this command executes are:</p>
<ul>
<li>Slugify column names</li>
<li>Rename columns with empty name to &ldquo;field_N&rdquo;</li>
<li>Remove empty rows</li>
<li>Remove empty columns</li>
<li>Output dialect: excel</li>
<li>Output encoding: UTF-8</li>
</ul>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-64'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-64'>#</a>
      </div>
      <p>TODO: add option to preserve original key names
TODO: detect input_encoding for source
TODO: add &ndash;quiet</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">input_encoding</span> <span class="o">=</span> <span class="n">input_encoding</span> <span class="ow">or</span> <span class="n">DEFAULT_INPUT_ENCODING</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-65'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-65'>#</a>
      </div>
      <p>Detect dialect</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">with</span> <span class="n">open_compressed</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span> <span class="k">as</span> <span class="n">fobj</span><span class="p">:</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">fobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">sample_size</span><span class="p">)</span>
    <span class="n">dialect</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">csv</span><span class="o">.</span><span class="n">discover_dialect</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">input_encoding</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-66'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-66'>#</a>
      </div>
      <p>Get header</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">with</span> <span class="n">open_compressed</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">input_encoding</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span> <span class="k">as</span> <span class="n">fobj</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">fobj</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">make_header</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-67'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-67'>#</a>
      </div>
      <p>Detect empty columns</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">with</span> <span class="n">open_compressed</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">input_encoding</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span> <span class="k">as</span> <span class="n">fobj</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">fobj</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>  <span class="c1"># Skip header</span>
        <span class="n">empty_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Detecting empty columns&quot;</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>  <span class="c1"># Empty row</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">empty_columns</span><span class="p">:</span>
                    <span class="n">empty_columns</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">empty_columns</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">if</span> <span class="n">in_place</span><span class="p">:</span>
        <span class="n">temp_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">())</span>
        <span class="n">destination</span> <span class="o">=</span> <span class="n">temp_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

    <span class="n">fobj</span> <span class="o">=</span> <span class="n">open_compressed</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">input_encoding</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">fobj</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>  <span class="c1"># Skip header</span>
    <span class="n">field_indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">empty_columns</span><span class="p">]</span>
    <span class="n">create_new_row</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">field_indexes</span><span class="p">]</span>

    <span class="n">output_fobj</span> <span class="o">=</span> <span class="n">open_compressed</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">output_encoding</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">output_fobj</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">field_name</span> <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">empty_columns</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Converting file&quot;</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">create_new_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>  <span class="c1"># Empty row</span>
            <span class="k">continue</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="n">fobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">output_fobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">in_place</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">temp_path</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-68'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-68'>#</a>
      </div>
      <p>Split CSV into equal parts (by number of lines).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;csv-row-count&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Lazily count CSV rows&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--input-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--buffer-size&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_BUFFER_SIZE</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--dialect&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--sample-size&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_SAMPLE_SIZE</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">csv_row_count</span><span class="p">(</span><span class="n">input_encoding</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
    <span class="n">input_encoding</span> <span class="o">=</span> <span class="n">input_encoding</span> <span class="ow">or</span> <span class="n">DEFAULT_INPUT_ENCODING</span>

    <span class="k">if</span> <span class="n">dialect</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Detect dialect</span>
        <span class="k">with</span> <span class="n">open_compressed</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fobj</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">fobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">sample_size</span><span class="p">)</span>
        <span class="n">dialect</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">csv</span><span class="o">.</span><span class="n">discover_dialect</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">input_encoding</span><span class="p">)</span>

    <span class="n">fobj</span> <span class="o">=</span> <span class="n">open_compressed</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">input_encoding</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">fobj</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">)</span>
    <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>  <span class="c1"># Read header</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">)</span>
    <span class="n">fobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;csv-split&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--input-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--output-encoding&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--buffer-size&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_BUFFER_SIZE</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--quiet&quot;</span><span class="p">,</span> <span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--destination-pattern&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Template name for destination files, like: `myfile-</span><span class="si">{part:03d}</span><span class="s2">.csv`&quot;</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">csv_split</span><span class="p">(</span><span class="n">input_encoding</span><span class="p">,</span> <span class="n">output_encoding</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">,</span> <span class="n">quiet</span><span class="p">,</span> <span class="n">destination_pattern</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-69'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-69'>#</a>
      </div>
      <p>Input and output files can be compressed.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">input_encoding</span> <span class="o">=</span> <span class="n">input_encoding</span> <span class="ow">or</span> <span class="n">DEFAULT_INPUT_ENCODING</span>
    <span class="k">if</span> <span class="n">destination_pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">first_part</span><span class="p">,</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extension</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">COMPRESSED_EXTENSIONS</span><span class="p">:</span>
            <span class="n">first_part</span><span class="p">,</span> <span class="n">new_extension</span> <span class="o">=</span> <span class="n">first_part</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="n">new_extension</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">extension</span>
        <span class="n">destination_pattern</span> <span class="o">=</span> <span class="n">first_part</span> <span class="o">+</span> <span class="s2">&quot;-</span><span class="si">{part:03d}</span><span class="s2">.&quot;</span> <span class="o">+</span> <span class="n">extension</span>

    <span class="n">part</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">output_fobj</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">input_fobj</span> <span class="o">=</span> <span class="n">open_compressed</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">input_encoding</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">input_fobj</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reader</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">%</span> <span class="n">lines</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output_fobj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">output_fobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">part</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">output_fobj</span> <span class="o">=</span> <span class="n">open_compressed</span><span class="p">(</span>
                <span class="n">destination_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">part</span><span class="o">=</span><span class="n">part</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">output_encoding</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">output_fobj</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="n">input_fobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-70'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-70'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;list-sheets&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;List sheets&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">list_sheets</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="n">extension</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="n">source</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">extension</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;xls&quot;</span><span class="p">,</span> <span class="s2">&quot;xlsx&quot;</span><span class="p">,</span> <span class="s2">&quot;ods&quot;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-71'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-71'>#</a>
      </div>
      <p>TODO: support for &lsquo;sheet_names&rsquo; should be introspected from plugins</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;ERROR: file type &#39;</span><span class="si">{}</span><span class="s2">&#39; not supported.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extension</span><span class="p">),</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">extension</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">rows</span><span class="o">.</span><span class="n">plugins</span><span class="p">):</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;ERROR: extension &#39;</span><span class="si">{}</span><span class="s2">&#39; not installed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extension</span><span class="p">),</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

    <span class="n">sheet_names_function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">rows</span><span class="o">.</span><span class="n">plugins</span><span class="p">,</span> <span class="n">extension</span><span class="p">),</span> <span class="s2">&quot;sheet_names&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sheet_name</span> <span class="ow">in</span> <span class="n">sheet_names_function</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">sheet_name</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">cli</span><span class="p">()</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
